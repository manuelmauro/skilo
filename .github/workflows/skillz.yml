name: Skillz

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      skill_path:
        description: 'Path to skills directory'
        required: false
        default: '.'
      new_skill_name:
        description: 'Name of new skill to create (optional)'
        required: false
        default: ''
      lang:
        description: 'Script language for new skill'
        required: false
        default: 'python'
        type: choice
        options:
          - python
          - bash
          - javascript
          - typescript

env:
  SKILLZ_VERSION: '0.1.0'

jobs:
  check:
    name: Validate Skills
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install skillz
        run: |
          # Option 1: Install from crates.io (when published)
          # cargo install skillz

          # Option 2: Install from GitHub releases
          curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ env.SKILLZ_VERSION }}/skillz-linux-x86_64.tar.gz | tar xz
          sudo mv skillz /usr/local/bin/

          # Option 3: Build from source (fallback)
          # cargo build --release
          # sudo cp target/release/skillz /usr/local/bin/

      - name: Lint skills
        run: skillz lint ${{ inputs.skill_path || '.' }} --format sarif > skillz-lint.sarif
        continue-on-error: true

      - name: Check formatting
        run: skillz fmt ${{ inputs.skill_path || '.' }} --check
        continue-on-error: true

      - name: Run full check
        run: skillz check ${{ inputs.skill_path || '.' }}

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: skillz-lint.sarif
        continue-on-error: true

  # Optional: Run on specific skill directories
  matrix-check:
    name: Check ${{ matrix.skill }}
    runs-on: ubuntu-latest
    if: false  # Enable by setting to: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        skill:
          - skills/example-skill
          # Add more skill paths here
    steps:
      - uses: actions/checkout@v4

      - name: Install skillz
        run: |
          curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ env.SKILLZ_VERSION }}/skillz-linux-x86_64.tar.gz | tar xz
          sudo mv skillz /usr/local/bin/

      - name: Validate ${{ matrix.skill }}
        run: skillz check ${{ matrix.skill }}

  # Example: Create a new skill (manual trigger only)
  scaffold:
    name: Create New Skill
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.new_skill_name != ''
    steps:
      - uses: actions/checkout@v4

      - name: Install skillz
        run: |
          curl -fsSL https://github.com/${{ github.repository }}/releases/download/v${{ env.SKILLZ_VERSION }}/skillz-linux-x86_64.tar.gz | tar xz
          sudo mv skillz /usr/local/bin/

      - name: Create skill
        run: |
          skillz new ${{ inputs.new_skill_name }} \
            --template hello-world \
            --lang ${{ inputs.lang }}

      - name: Validate new skill
        run: skillz check ${{ inputs.new_skill_name }}

      - name: Show generated files
        run: |
          echo "Generated skill structure:"
          find ${{ inputs.new_skill_name }} -type f
          echo ""
          echo "SKILL.md contents:"
          cat ${{ inputs.new_skill_name }}/SKILL.md
